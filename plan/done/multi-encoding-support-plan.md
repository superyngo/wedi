# 多編碼支援開發計畫

## 背景
wedi 編輯器目前僅支援 UTF-8 編碼文件。為了支援更多編碼格式（如 GBK、Shift-JIS 等），需要在最小改動的前提下實現編碼檢測和轉換功能。

## 目標
- 在不破壞現有 UTF-8 文件支援的前提下，添加對多種編碼的支援
- 實現自動編碼檢測（基於 BOM 或用戶指定）
- 保持編輯器核心邏輯不變，僅修改文件讀寫層

## 編碼原則/風格
- 統一
- 精確
- 一致

## 技術方案

### 依賴添加
- 添加 `encoding_rs` crate：Mozilla 維護的編碼處理庫，支援多種編碼格式
- 版本：`encoding_rs = "0.8"`

### 核心修改
1. **RopeBuffer 結構擴展**
   - 添加 `encoding: &'static Encoding` 字段
   - 預設值：UTF-8

2. **文件讀取邏輯**
   - 讀取文件為位元組數組
   - 檢測 BOM 或使用指定編碼
   - 解碼為 UTF-8 存入 Rope

3. **文件保存邏輯**
   - 將 Rope 內容轉為 UTF-8 字符串
   - 使用指定編碼重新編碼為位元組
   - 寫入文件

### 編碼檢測策略
- **優先級**：BOM > 用戶指定 > 自動檢測（使用 chardet crate 可選）
- **支援編碼**：UTF-8, UTF-16LE/BE, GBK, Shift-JIS, ISO-8859-1 等

## 實施步驟

### Phase 1: 基礎設置 (1-2 天)
1. 添加 `encoding_rs` 依賴到 Cargo.toml
2. 在 RopeBuffer 結構中添加編碼字段
3. 修改 from_file 方法實現編碼檢測和解碼

### Phase 2: 保存功能 (1 天)
1. 修改 save/save_as 方法實現編碼輸出
2. 添加編碼設置方法（供未來 UI 使用）

### Phase 3: 命令行支援 (1 天)
1. 在 CLI 參數中添加 `--encoding` 選項
2. 實現編碼驗證邏輯

### Phase 4: 測試與優化 (2 天)
1. 編寫單元測試覆蓋不同編碼
2. 處理邊界情況（無效編碼、無 BOM 文件）
3. 性能測試（大文件編碼轉換）

## 測試要點
- UTF-8 文件向後兼容
- BOM 檢測準確性
- 編碼轉換正確性（中日韓字符）
- 錯誤處理（無效位元組）
- 性能影響（< 10% 開銷）

## 風險評估

| 風險 | 影響 | 緩解措施 |
|------|------|----------|
| 編碼檢測失敗 | 中 | 提供 fallback 到 UTF-8，提供用戶提示 |
| 性能下降 | 低 | 僅在文件讀寫時進行轉換，編輯時保持 UTF-8 |
| 編碼轉換錯誤 | 高 | 完善的錯誤處理和用戶通知 |
| 依賴複雜度 | 低 | 使用成熟的 encoding_rs crate |

## 時間估計
- 總計：5-6 天
- 包含測試和文檔更新

## 驗收標準
- [ ] 支援至少 5 種常見編碼
- [ ] UTF-8 文件零影響
- [ ] 編碼錯誤時提供清晰提示
- [ ] 通過所有編碼相關測試
- [ ] 性能影響 < 5%</content>
<parameter name="filePath">d:\Users\user\Documents\rust\wedi\multi-encoding-support-plan.md